<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dentical CRM Dashboard</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #f8fafc; font-family: sans-serif; -webkit-tap-highlight-color: transparent; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.2s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Grafik stillari */
        .day-tab.active { background: #2563eb; color: white; }
        .time-row { height: 45px; border-bottom: 1px solid #f1f5f9; position: relative; display: flex; align-items: center; justify-content: center; }
        .appt-block { position: absolute; left: 4px; right: 4px; border-radius: 12px; padding: 8px; z-index: 10; font-size: 11px; border-left: 5px solid rgba(0,0,0,0.2); box-shadow: 0 4px 6px rgba(0,0,0,0.05); cursor: pointer; }
        
        /* Status Ranglari */
        .status-waiting, .NEW { background: #fef3c7; color: #92400e; border-left-color: #f59e0b; }
        .status-done, .READY { background: #dcfce7; color: #166534; border-left-color: #22c55e; }
        .status-cancel, .PROCESS { background: #fee2e2; color: #991b1b; border-left-color: #ef4444; }

        /* Modal */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; align-items: flex-end; }
        .modal.active { display: flex; }
        .modal-content { background: white; width: 100%; border-radius: 24px 24px 0 0; padding: 20px; animation: slideUp 0.3s; max-height: 90vh; overflow-y: auto; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        input, select, textarea { width: 100%; background: #f1f5f9; border: none; padding: 14px; border-radius: 16px; margin-bottom: 10px; outline: none; font-weight: 600; }
        .lab-card { background: white; border-radius: 20px; padding: 16px; margin-bottom: 12px; border-left: 6px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: pointer; }

        /* BLOKIROVKA EKRANI */
        #payScreen { display: none; position: fixed; inset: 0; background: white; z-index: 10000; flex-direction: column; align-items: center; justify-content: center; padding: 30px; text-align: center; }
    </style>
</head>
<body class="pb-24">

    <div id="payScreen">
        <div class="bg-red-50 w-20 h-20 rounded-full flex items-center justify-center mb-6">
            <i class="fas fa-lock text-3xl text-red-500"></i>
        </div>
        <h2 class="text-2xl font-black mb-2 text-slate-800 uppercase italic">Muddat Tugadi</h2>
        <p class="text-slate-500 mb-8 text-sm">Dasturdan foydalanishni davom ettirish uchun to'lov qiling.</p>
        
        <div class="bg-slate-50 p-6 rounded-[32px] w-full mb-8 border border-slate-100">
            <div class="flex justify-between items-center mb-4">
                <span class="text-slate-400 text-[10px] font-bold uppercase tracking-widest">Obuna (1 oy)</span>
                <span class="font-black text-green-600 text-lg">50,000 UZS</span>
            </div>
            
            <div onclick="copyCard()" class="bg-white p-4 rounded-2xl border-2 border-dashed border-blue-100 cursor-pointer active:scale-95 transition-transform">
                <p class="text-[9px] font-bold text-blue-400 mb-1 uppercase tracking-tighter">Karta raqami (Nusxalash uchun bosing)</p>
                <p class="font-black text-slate-800 text-lg tracking-wider">5614 6812 5339 5069</p>
                <p class="text-[10px] text-slate-400 mt-1">Dentical CRM System</p>
            </div>
        </div>

        <a href="https://t.me/OzingizniLichkangiz" class="w-full bg-blue-600 text-white py-5 rounded-2xl font-black uppercase text-xs tracking-widest shadow-xl shadow-blue-100 mb-4 block">To'lov chekini yuborish</a>
        <p class="text-[10px] text-slate-300 font-bold uppercase">To'lovdan so'ng dastur ochib beriladi</p>
    </div>

    <div id="mainApp">
        <div id="page-calendar" class="page active">
            <div class="bg-white sticky top-0 z-50 shadow-sm p-4">
                <div class="flex justify-between items-center mb-3">
                    <h1 class="text-xl font-bold">Yanvar 2025</h1>
                    <span class="text-blue-600 bg-blue-50 px-3 py-1 rounded-full text-xs font-bold">1-Xona</span>
                </div>
                <div id="dayTabs" class="flex gap-2 overflow-x-auto pb-1 no-scrollbar"></div>
            </div>
            <div class="flex bg-white relative">
                <div id="timeLabels" class="w-16 border-r text-[10px] text-slate-400 bg-slate-50/50"></div>
                <div id="schedule-grid" class="flex-1 relative"></div>
            </div>
        </div>

        <div id="page-lab" class="page">
            <div class="p-4 flex justify-between items-center bg-white sticky top-0 z-50 shadow-sm">
                <div>
                    <h1 class="text-2xl font-bold">Laboratoriya</h1>
                </div>
                <button onclick="openAddLab()" class="bg-blue-600 text-white px-5 py-2.5 rounded-2xl font-bold text-sm shadow-lg shadow-blue-100">+ Yangi ish</button>
            </div>
            <div id="labList" class="p-4"></div>
        </div>

        <div id="page-metodichka" class="page">
            <div class="p-6 bg-white border-b shadow-sm"><h1 class="text-2xl font-black">Metodichka</h1></div>
            <div class="p-4 space-y-4" id="metodContent">
                </div>
        </div>

        <div id="page-kassa" class="page">
            <div class="p-6 bg-white border-b shadow-sm"><h1 class="text-2xl font-black">Kassa</h1></div>
            <div class="p-4">
                <div class="bg-gradient-to-br from-green-600 to-green-700 p-8 rounded-[35px] shadow-xl text-white mb-6 text-center">
                    <p class="text-xs font-bold opacity-80 uppercase tracking-widest">Bugungi tushum</p>
                    <h2 id="totalCash" class="text-4xl font-black mt-1">0 UZS</h2>
                </div>
                <div id="cashList" class="space-y-3"></div>
            </div>
        </div>

        <nav class="fixed bottom-0 w-full bg-white border-t p-4 flex justify-around shadow-[0_-5px_20px_rgba(0,0,0,0.05)] z-50">
            <button onclick="showPage('calendar')" id="nav-calendar" class="text-blue-600 flex flex-col items-center"><i class="fa fa-calendar-alt text-xl"></i><span class="text-[10px] mt-1 font-bold">Grafik</span></button>
            <button onclick="showPage('lab')" id="nav-lab" class="text-slate-300 flex flex-col items-center"><i class="fa fa-flask text-xl"></i><span class="text-[10px] mt-1 font-bold">Lab</span></button>
            <button onclick="showPage('metodichka')" id="nav-metodichka" class="text-slate-300 flex flex-col items-center"><i class="fa fa-notes-medical text-xl"></i><span class="text-[10px] mt-1 font-bold">Metod</span></button>
            <button onclick="showPage('kassa')" id="nav-kassa" class="text-slate-300 flex flex-col items-center"><i class="fa fa-wallet text-xl"></i><span class="text-[10px] mt-1 font-bold">Kassa</span></button>
        </nav>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-5">
                <h2 id="modalTitle" class="font-bold text-xl">Qabul</h2>
                <button onclick="deleteEntry()" id="deleteBtn" class="text-red-500 hidden px-3"><i class="fa fa-trash"></i></button>
            </div>
            <input id="pName" type="text" placeholder="Bemor Ismi">
            <input id="pPhone" type="tel" placeholder="+998">
            <div class="flex gap-2">
                <select id="pDaySelect" class="flex-1"></select>
                <select id="pStart" class="flex-1"></select>
                <select id="pEnd" class="flex-1"></select>
            </div>
            <select id="pStatus">
                <option value="status-waiting">ðŸŸ¡ Rejada</option>
                <option value="status-done">ðŸŸ¢ Keldi</option>
                <option value="status-cancel">ðŸ”´ Kelmadi</option>
            </select>
            <textarea id="pNote" placeholder="Zametka..."></textarea>
            <div class="flex gap-3">
                <button onclick="closeModal()" class="flex-1 py-4 text-slate-400 font-bold">Yopish</button>
                <button onclick="saveData()" class="flex-[2] bg-blue-600 text-white py-4 rounded-2xl font-bold">Saqlash</button>
            </div>
        </div>
    </div>

    <div id="labModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-5">
                <h2 id="labTitle" class="font-bold text-xl">Lab</h2>
                <button id="labDelBtn" onclick="deleteLab()" class="text-red-500 hidden px-3"><i class="fa fa-trash"></i></button>
            </div>
            <select id="lPatientSelect"></select>
            <select id="lTexnik"></select>
            <div class="flex gap-3">
                <div class="flex-1"><label class="text-[10px]">MUDDAT</label><input type="date" id="lSanaOut"></div>
            </div>
            <select id="lStatus">
                <option value="NEW">ðŸ”´ Yangi</option>
                <option value="READY">ðŸŸ¢ Tayyor</option>
            </select>
            <div class="flex gap-3 mt-4">
                <button onclick="closeLabModal()" class="flex-1 py-4 text-slate-400">Yopish</button>
                <button onclick="saveLab()" class="flex-[2] bg-blue-600 text-white py-4 rounded-2xl font-bold">Saqlash</button>
            </div>
        </div>
    </div>

    <script>
        // 1. BLOKIROVKA VA TRIAL TEKSHIRUVI
        function checkTrial() {
            const trialDays = 3;
            let installDate = localStorage.getItem('crm_install_date');
            let isPaid = localStorage.getItem('crm_is_paid') === 'true';

            if (!installDate) {
                installDate = new Date().getTime();
                localStorage.setItem('crm_install_date', installDate);
            }

            const now = new Date().getTime();
            const diffInDays = (now - installDate) / (1000 * 60 * 60 * 24);

            if (diffInDays > trialDays && !isPaid) {
                document.getElementById('mainApp').style.display = 'none';
                document.getElementById('payScreen').style.display = 'flex';
                return false;
            }
            return true;
        }

        function copyCard() {
            const card = "5614681253395069";
            navigator.clipboard.writeText(card);
            alert("Karta raqami nusxalandi!");
        }

        // 2. ASOSIY LOGIKA (ORIGINAL)
        let tg = window.Telegram.WebApp;
        let appointments = JSON.parse(localStorage.getItem('appts')) || []; 
        let labs = JSON.parse(localStorage.getItem('labs')) || [];
        let techList = JSON.parse(localStorage.getItem('techs')) || ["Jasur (Keramika)", "Sardor (Protez)"];
        let serviceList = JSON.parse(localStorage.getItem('servs')) || [{n:"Plomba", p:300000}, {n:"Udalenie", p:150000}];
        let kassa = JSON.parse(localStorage.getItem('kassaHistory')) || [];
        
        let selectedDay = 31;
        let currentEditId = null;
        let currentLabId = null;
        const rowHeight = 45;

        function showPage(p) {
            if(!checkTrial()) return;
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById('page-' + p).classList.add('active');
            document.querySelectorAll('nav button').forEach(b => {
                b.classList.remove('text-blue-600'); b.classList.add('text-slate-300');
            });
            document.getElementById('nav-' + p).classList.add('text-blue-600');
            if(p === 'kassa') renderKassa();
        }

        // Grafik Init
        const grid = document.getElementById('schedule-grid');
        for(let h=8; h<20; h++) {
            for(let m of ['00', '30']) {
                let t = `${h<10?'0'+h:h}:${m}`;
                document.getElementById('timeLabels').innerHTML += `<div class="time-row">${t}</div>`;
                let row = document.createElement('div');
                row.className = 'time-row';
                row.onclick = () => openAddModal(t);
                grid.appendChild(row);
                document.getElementById('pStart').innerHTML += `<option value="${t}">${t}</option>`;
                document.getElementById('pEnd').innerHTML += `<option value="${t}">${t}</option>`;
            }
        }

        const days = [31, 1, 2, 3, 4, 5];
        days.forEach(d => {
            document.getElementById('dayTabs').innerHTML += `
                <div onclick="selectDay(this, ${d})" class="day-tab ${d==selectedDay?'active':'bg-slate-50'} min-w-[60px] p-4 rounded-2xl flex flex-col items-center">
                    <span class="text-[10px] font-bold opacity-40">${d==31?'DEK':'YAN'}</span>
                    <span class="text-xl font-bold">${d}</span>
                </div>`;
            document.getElementById('pDaySelect').innerHTML += `<option value="${d}">${d}-${d==31?'Dek':'Yan'}</option>`;
        });

        function selectDay(el, d) {
            document.querySelectorAll('.day-tab').forEach(t => t.classList.remove('active'));
            el.classList.add('active'); selectedDay = d; render();
        }

        function openAddModal(t) {
            if(!checkTrial()) return;
            currentEditId = null; document.getElementById('modalTitle').innerText = "Yangi qabul";
            document.getElementById('deleteBtn').classList.add('hidden');
            document.getElementById('pName').value = ""; document.getElementById('pStart').value = t;
            document.getElementById('modal').classList.add('active');
        }

        function saveData() {
            const data = { id: currentEditId || Date.now(), day: parseInt(document.getElementById('pDaySelect').value), name: document.getElementById('pName').value, start: document.getElementById('pStart').value, end: document.getElementById('pEnd').value, status: document.getElementById('pStatus').value };
            if(!data.name) return;
            if(currentEditId) appointments = appointments.filter(a => a.id !== currentEditId);
            appointments.push(data); localStorage.setItem('appts', JSON.stringify(appointments)); render(); closeModal();
        }

        function render() {
            document.querySelectorAll('.appt-block').forEach(b => b.remove());
            appointments.filter(a => a.day == selectedDay).forEach(a => {
                const sIdx = timeToIdx(a.start), eIdx = timeToIdx(a.end);
                const b = document.createElement('div');
                b.className = `appt-block ${a.status}`;
                b.style.top = (sIdx * rowHeight) + "px"; b.style.height = ((eIdx - sIdx) * rowHeight - 2) + "px";
                b.innerHTML = `<div class="font-bold truncate text-[10px] uppercase">${a.name}</div>`;
                b.onclick = (e) => { e.stopPropagation(); };
                grid.appendChild(b);
            });
        }

        function renderKassa() {
            const list = document.getElementById('cashList'); list.innerHTML = "";
            let total = 0;
            kassa.forEach(i => {
                total += parseInt(i.total.replace(/,/g, ''));
                list.innerHTML += `<div class="bg-white p-4 rounded-2xl flex justify-between shadow-sm border border-slate-50"><p class="font-bold uppercase text-xs">${i.p}</p><p class="font-black text-green-600">${i.total}</p></div>`;
            });
            document.getElementById('totalCash').innerText = total.toLocaleString() + " UZS";
        }

        function timeToIdx(t) { let [h, m] = t.split(':').map(Number); return (h - 8) * 2 + (m === 30 ? 1 : 0); }
        function closeModal() { document.getElementById('modal').classList.remove('active'); }
        function closeLabModal() { document.getElementById('labModal').classList.remove('active'); }

        window.onload = () => {
            tg.expand();
            if(checkTrial()) {
                render();
            }
        };
    </script>
</body>
</html>
